@page "/Matches"
@using AnglingClubShared.DTOs
@using AnglingClubShared.Entities
@using AnglingClubShared.Enums
@using AnglingClubShared.Models
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Microsoft.AspNetCore.Authorization
@using static AnglingClubWebsite.Pages.MatchesViewModel
@inherits MvvmComponentBase<MatchesViewModel>

<AuthorizationRequired>
    <div class="page-header">
        <h3 class="left-header">Matches</h3>

        <SeasonSelector OnSeasonChanged="ViewModel.SeasonChanged" />

    </div>

    <BusyIndicator IsReady="@ViewModel.DataLoaded"></BusyIndicator>

    @if (ViewModel.DataLoaded)
    {
        <p>You can see more details of each match and the results by selecting the match.</p>

        <SfTab ID="Tab" EnablePersistence="false" SelectedItem="ViewModel.SelectedTab">
            <TabEvents Selected="OnTabSelected"></TabEvents>
            <TabItems>
                @foreach (MatchTabData Item in ViewModel.MatchTabItems)
                {
                    <TabItem>
                        <HeaderTemplate>
                            @if (ViewModel.BrowserSize == DeviceSize.Small)
                            {
                                <div>@(Item.HeaderBrief)</div>
                            }
                            else
                            {
                                <div>@(Item.HeaderFull)</div>
                            }

                        </HeaderTemplate>
                    </TabItem>
                }
            </TabItems>
        </SfTab>

        <div class="matches grid-shrinkwrap">
            <SfGrid @ref="Grid" DataSource="@ViewModel.Matches" AllowSorting="true" AllowFiltering="false" AllowTextWrap="false">
                <GridEvents DataBound="DataboundHandler" QueryCellInfo="QueryCellInfoHandler" RowSelected="MatchSelectedHandler" TValue="ClubEvent"></GridEvents>
                <GridFilterSettings Type="@Syncfusion.Blazor.Grids.FilterType.Excel" />
                <GridSelectionSettings Type="@Syncfusion.Blazor.Grids.SelectionType.Single" Mode="@Syncfusion.Blazor.Grids.SelectionMode.Row"></GridSelectionSettings>
                <GridTextWrapSettings WrapMode="WrapMode.Content" />

                <GridColumns>
                    <GridColumn Field=@nameof(ClubEvent.Date) HeaderText="Date" Format="dd MMM yy" Type="Syncfusion.Blazor.Grids.ColumnType.Date" />
                    <GridColumn Field=@nameof(ClubEvent.Time) Visible="@ViewModel.IsTimeVisible()" HeaderText="Time" />
                    <GridColumn Field=@nameof(ClubEvent.Description) HeaderText="Venue" CustomAttributes="@(new Dictionary<string, object>() { { "class", "e-wrap" } })" />
                    <GridColumn Field=@nameof(ClubEvent.Cup) Visible="@ViewModel.IsCupVisible()" HeaderText="Cup" CustomAttributes="@(new Dictionary<string, object>() { { "class", "e-wrap" } })" />
                    <GridColumn Field=@nameof(ClubEvent.Number) HeaderText="No" Format="N0" TextAlign="TextAlign.Right" />
                </GridColumns>

            </SfGrid>

        </div>

        @* Note the 2-way binding of the Visible property *@
        <MatchResultsPopup @bind-Visible="ViewModel.ShowingResults" SelectedMatch="@ViewModel.SelectedMatch"></MatchResultsPopup>

    }
</AuthorizationRequired>

<style>


</style>

    @code {
    private SfGrid<ClubEvent>? Grid; 

    public void OnTabSelected(SelectEventArgs args)
    {
        var selected = ViewModel.MatchTabItems.ToArray()[args.SelectedIndex].MatchType;
        Console.WriteLine($"Selected item: {args.SelectedIndex} - {selected}");
        ViewModel.SelectedMatchType = selected;
        ViewModel.LoadMatchesForSelectedType();
    }

    public async Task DataboundHandler(object args)
    {
        await this.Grid!.AutoFitColumnsAsync();
    }

    public void QueryCellInfoHandler(Syncfusion.Blazor.Grids.QueryCellInfoEventArgs<ClubEvent> args)
    {
        var match = args.Data;

        if (match.InThePast)
        {
            args.Cell.AddClass(new string[] { "date-past" });
        }
        else
        {
            args.Cell.AddClass(new string[] { "date-future" });
        }
    }

    public void MatchSelectedHandler(RowSelectEventArgs<ClubEvent> args)
    {
        ViewModel.SelectedMatch = args.Data;
        ViewModel.ShowingResults = true;
    }

}
