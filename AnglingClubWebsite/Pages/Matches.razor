@page "/Matches"
@using AnglingClubShared.DTOs
@using AnglingClubShared.Entities
@using AnglingClubShared.Enums
@using AnglingClubShared.Models
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Microsoft.AspNetCore.Authorization
@using static AnglingClubWebsite.Pages.MatchesViewModel
@inherits MvvmComponentBase<MatchesViewModel>

<AuthorizationRequired>
    <div style="display: block !important;">
        <h3 class="left-header">Matches</h3>

        <SeasonSelector OnSeasonChanged="@(async (season) => await ViewModel.SeasonChanged(season))"></SeasonSelector>

    </div>
    <br />

    <BusyIndicator IsReady="@ViewModel.DataLoaded"></BusyIndicator>

    @if (ViewModel.DataLoaded)
    {
        <p>You can see more details of each match and the results by selecting the match.</p>

        <SfTab ID="Tab" EnablePersistence="false" SelectedItem="ViewModel.SelectedTab">
            <TabEvents Selected="OnTabSelected"></TabEvents>
            <TabItems>
                @foreach (MatchTabData Item in ViewModel.MatchTabItems)
                {
                    <TabItem>
                        <HeaderTemplate>
                            @if (ViewModel.BrowserSize == DeviceSize.Small)
                            {
                                <div>@(Item.HeaderBrief)</div>
                            }
                            else
                            {
                                <div>@(Item.HeaderFull)</div>
                            }

                        </HeaderTemplate>
                    </TabItem>
                }
            </TabItems>
        </SfTab>

        <div class="grid-shrinkwrap">
            <SfGrid @ref="Grid" DataSource="@ViewModel.Matches" AllowSorting="true" AllowFiltering="false">
                <GridEvents DataBound="DataboundHandler" QueryCellInfo="QueryCellInfoHandler" RowSelected="MatchSelectedHandler" TValue="ClubEvent"></GridEvents>
                <GridFilterSettings Type="@Syncfusion.Blazor.Grids.FilterType.Excel" />
                <GridSelectionSettings Type="@Syncfusion.Blazor.Grids.SelectionType.Single" Mode="@Syncfusion.Blazor.Grids.SelectionMode.Row"></GridSelectionSettings>

                <GridColumns>
                    <GridColumn Field=@nameof(ClubEvent.Date) HeaderText="Date" Format="dd MMM yy" Type="Syncfusion.Blazor.Grids.ColumnType.Date" />
                    <GridColumn Field=@nameof(ClubEvent.Time) Visible="@ViewModel.IsTimeVisible()" HeaderText="Time" />
                    <GridColumn Field=@nameof(ClubEvent.Description) HeaderText="Venue" CustomAttributes="@(new Dictionary<string, object>() { { "class", "e-wrap" } })" />
                    <GridColumn Field=@nameof(ClubEvent.Cup) Visible="@ViewModel.IsCupVisible()" HeaderText="Cup" CustomAttributes="@(new Dictionary<string, object>() { { "class", "e-wrap" } })" />
                    <GridColumn Field=@nameof(ClubEvent.Number) HeaderText="No" Format="N0" TextAlign="TextAlign.Right" />
                </GridColumns>

            </SfGrid>

        </div>

        <div>
            <SfDialog IsModal="true" Visible="@ViewModel.ShowingResults" CssClass="details-dialog" >
                @if (ViewModel.GlobalService.IsEmbedded)
                {
                    <DialogPositionData X="center" Y="top"></DialogPositionData>
                }
                <DialogTemplates>
                    <Header>Match Details</Header>
                    <Content>
                        <div class="match-results">
                            @if (ViewModel.CurrentUser.Admin && ViewModel.ResultsLoaded && ViewModel.MatchResults.Any())
                            {
                                <div style="float: right;">
                                    <SfCheckBox Label="Show peg" @bind-Checked="@ViewModel.ShowPeg"></SfCheckBox>
                                </div>
                            }
                            @if (ViewModel.BrowserPortrait)
                            {
                                <table>
                                    <tr><td class="label">Match:</td><td>@ViewModel.SelectedMatch!.MatchType No. @ViewModel.SelectedMatch!.Number</td></tr>
                                    <tr><td class="label">Date:</td><td>@ViewModel.SelectedMatch!.Day @ViewModel.SelectedMatch!.Date.ToString("dd MMM yy")</td></tr>
                                    <tr><td class="label">Venue:</td><td>@ViewModel.SelectedMatch!.Description</td></tr>
                                    @if (!ViewModel.SelectedMatch!.Cup.IsWhiteSpace())
                                    {
                                        <tr><td class="label">Cup:</td><td>@ViewModel.SelectedMatch!.Cup</td></tr>
                                    }
                                </table>
                            }
                            else
                            {
                                <table>
                                    <tr><td class="label">Match:</td><td>@ViewModel.SelectedMatch!.MatchType No. @ViewModel.SelectedMatch!.Number</td><td class="label">Venue:</td><td>@ViewModel.SelectedMatch!.Description</td></tr>
                                    <tr>
                                        <td class="label">Date:</td>
                                        <td>@ViewModel.SelectedMatch!.Day @ViewModel.SelectedMatch!.Date.ToString("dd MMM yy")</td>
                                        @if (!ViewModel.SelectedMatch!.Cup.IsWhiteSpace())
                                        {
                                            <td class="label">Cup:</td>
                                            <td>@ViewModel.SelectedMatch!.Cup</td>
                                        }
                                    </tr>
                                </table>
                            }
                            <br />
                            <h6>Results</h6>
                            <BusyIndicator IsReady="@ViewModel.ResultsLoaded"></BusyIndicator>
                            @if (ViewModel.ResultsLoaded)
                            {
                                @if (ViewModel.MatchResults.Any())
                                {
                                    <div class="results-grid">
                                        <SfGrid @ref="ResultsGrid" DataSource="@ViewModel.MatchResults" AllowSorting="false" AllowTextWrap="true" AllowFiltering="false" >
                                            <GridTextWrapSettings WrapMode="WrapMode.Content" />

                                            <GridColumns>
                                                <GridColumn Field=@nameof(MatchResultOutputDto.PositionOrdinal) HeaderText="Pos" Width="50"  />
                                                <GridColumn Field=@nameof(MatchResultOutputDto.Name) HeaderText="Name" CustomAttributes="@(new Dictionary<string, object> { ["class"] = "e-wrap" })" />
                                                <GridColumn Field=@nameof(MatchResultOutputDto.Peg) Visible="@ViewModel.ShowPeg" HeaderText="Peg" Format="N0" TextAlign="TextAlign.Right" Width="50" />
                                                <GridColumn Field=@nameof(MatchResultOutputDto.Weight) HeaderText="Weight" CustomAttributes="@(new Dictionary<string, object> { ["class"] = "e-wrap" })" Width="80" />
                                                <GridColumn Field=@nameof(MatchResultOutputDto.Points) HeaderText="Pts" Format="N0" TextAlign="TextAlign.Right" Width="40"/>
                                            </GridColumns>

                                        </SfGrid>
                                    </div>
                                }
                                else
                                {
                                    <p>Sorry, not available</p>
                                }
                            }
                        </div>
                    </Content>
                </DialogTemplates>
                <DialogButtons>
                    <DialogButton Content="Close" IsPrimary="true" OnClick="(() => ViewModel.ShowingResults = false)" />
                </DialogButtons>
            </SfDialog>
        </div>

    }
</AuthorizationRequired>

<style>


</style>

@code {
    private SfGrid<ClubEvent>? Grid; 
    private SfGrid<MatchResultOutputDto>? ResultsGrid;

    public void OnTabSelected(SelectEventArgs args)
    {
        var selected = ViewModel.MatchTabItems.ToArray()[args.SelectedIndex].MatchType;
        Console.WriteLine($"Selected item: {args.SelectedIndex} - {selected}");
        ViewModel.SelectedMatchType = selected;
        ViewModel.LoadMatchesForSelectedType();
    }

    public void DataboundHandler(object args)
    {
        this.Grid!.AutoFitColumnsAsync();
    }

    public void ResultsDataboundHandler(object args)
    {
        this.ResultsGrid!.AutoFitColumnsAsync();
    }

    public void QueryCellInfoHandler(Syncfusion.Blazor.Grids.QueryCellInfoEventArgs<ClubEvent> args)
    {
        var match = args.Data;

        if (match.InThePast)
        {
            args.Cell.AddClass(new string[] { "date-past" });
        }
        else
        {
            args.Cell.AddClass(new string[] { "date-future" });
        }
    }

    public void MatchSelectedHandler(RowSelectEventArgs<ClubEvent> args)
    {
        ViewModel.ShowResults(args.Data);
    }

}
