@page "/Matches"
@using AnglingClubShared.DTOs
@using AnglingClubShared.Entities
@using AnglingClubShared.Enums
@using AnglingClubShared.Models
@using Microsoft.AspNetCore.Components.QuickGrid
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Microsoft.AspNetCore.Authorization
@using static AnglingClubWebsite.Pages.MatchesViewModel
@inherits MvvmComponentBase<MatchesViewModel>

<AuthorizationRequired>
    <div class="page-header">
        <h3 class="left-header">Matches</h3>

        <SeasonSelector OnSeasonChanged="ViewModel.SeasonChanged" />
    </div>

    <BusyIndicator IsReady="@ViewModel.DataLoaded"></BusyIndicator>

    @if (ViewModel.DataLoaded)
    {
        <p>You can see more details of each match and the results by selecting the match.</p>

        <SfTab ID="Tab" EnablePersistence="false" SelectedItem="ViewModel.SelectedTab">
            <TabEvents Selected="OnTabSelected"></TabEvents>
            <TabItems>
                @foreach (MatchTabData Item in ViewModel.MatchTabItems)
                {
                    <TabItem>
                        <HeaderTemplate>
                            @if (ViewModel.BrowserSize == DeviceSize.Small)
                            {
                                <div>@(Item.HeaderBrief)</div>
                            }
                            else
                            {
                                <div>@(Item.HeaderFull)</div>
                            }

                        </HeaderTemplate>
                    </TabItem>
                }
            </TabItems>
        </SfTab>
        <div class="bdac-table-scroll-container">
            <QuickGrid Items="ViewModel.MatchesQueryable" Class="bdac-table table">

                <TemplateColumn Title="Date" IsDefaultSortColumn="true" Sortable="true" SortBy="@MatchesViewModel.SortByDate">
                    <ChildContent Context="row">
                        <div class="@ViewModel.CellClass(row)"
                             @onclick="() => ViewModel.MatchSelectedHandler(row)">
                            <span class="nowrap">@row.Date.ToString("dd MMM yy")</span>
                        </div>
                    </ChildContent>
                </TemplateColumn>

                <TemplateColumn Title="Venue">
                    <ChildContent Context="row">
                        <div class="@ViewModel.CellClass(row)"
                             @onclick="() => ViewModel.MatchSelectedHandler(row)">
                            @row.Description
                        </div>
                    </ChildContent>
                </TemplateColumn>

                @if (ViewModel.IsCupVisible())
                {
                    <TemplateColumn Title="Cup">
                        <ChildContent Context="row">
                            <div class="@ViewModel.CellClass(row)"
                                 @onclick="() => ViewModel.MatchSelectedHandler(row)">
                                @row.Cup
                            </div>
                        </ChildContent>
                    </TemplateColumn>
                }

                <TemplateColumn Title="No" Align="Align.Right">
                    <ChildContent Context="row">
                        <div class="@ViewModel.CellClass(row)"
                             @onclick="() => ViewModel.MatchSelectedHandler(row)">
                            @row.Number!.Value.ToString("N0")
                        </div>
                    </ChildContent>
                </TemplateColumn>

            </QuickGrid>
        </div>

        @* Note the 2-way binding of the Visible property *@
        <MatchResultsPopup @bind-Visible="ViewModel.ShowingResults" SelectedMatch="@ViewModel.SelectedMatch"></MatchResultsPopup>

    }
</AuthorizationRequired>

<style>


</style>

    @code {
    private SfGrid<ClubEvent>? Grid; 

    public void OnTabSelected(SelectEventArgs args)
    {
        var selected = ViewModel.MatchTabItems.ToArray()[args.SelectedIndex].MatchType;
        Console.WriteLine($"Selected item: {args.SelectedIndex} - {selected}");
        ViewModel.SelectedMatchType = selected;
        ViewModel.LoadMatchesForSelectedType();
    }

    public async Task DataboundHandler(object args)
    {
        await this.Grid!.AutoFitColumnsAsync();
    }

    public void QueryCellInfoHandler(Syncfusion.Blazor.Grids.QueryCellInfoEventArgs<ClubEvent> args)
    {
        var match = args.Data;

        if (match.InThePast)
        {
            args.Cell.AddClass(new string[] { "date-past" });
        }
        else
        {
            args.Cell.AddClass(new string[] { "date-future" });
        }
    }


}
